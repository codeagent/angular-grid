angular.module("angular-grid-view",["ngAnimate","ngSanitize","ui.bootstrap","ui.select","grid-view-templates"]).provider("gridView",function(){var t=this;this.dataColumnConfig={label:"",attribute:"",sortable:!0,template:"",templateUrl:"templates/grid-view/cell/data.tpl.html",type:"data",filter:"text"},this.checkboxColumnConfig={attribute:"",template:"",templateUrl:"templates/grid-view/cell/checkbox.tpl.html",type:"checkbox"},this.operationsColumnConfig={label:"Actions",template:"",templateUrl:"templates/grid-view/cell/operations.tpl.html",sortable:!1,filter:!1},this.defaultSort={},this.paginationConfig={page:1,pageSizeVariants:[{name:"10",value:10},{name:"25",value:25},{name:"50",value:50},{name:"100",value:100}],pageSize:10},this.defaultFilter={},this.operationConfig={id:"operation",label:"Operation",icon:"fa fa-pencil",make:function(t){return t},condition:function(t){return!0},multiple:!0,single:!0,reloadOnDone:!0},this.promptConfig={icon:"fa fa-pencil",label:"Prompt",condition:function(t){return!0},make:function(t){return t},prompt:{enabled:!0,title:"Action",message:"Do you really want  perform this action?"},multiple:!1,single:!1,reloadOnDone:!0},this.defaultTemplates={grid:"templates/grid-view/grid-view.tpl.html",modal:"templates/grid-view/modal.tpl.html",operationsDropdown:"templates/grid-view/_operations.tpl.html",pageSizeDropdown:"templates/grid-view/_page-size.tpl.html",pagination:"templates/grid-view/_pagination.tpl.html",summary:"templates/grid-view/_summary.tpl.html",table:"templates/grid-view/_table.tpl.html"},this.$get=["$q","$http","$templateCache","$injector","gridViewService","$uibModal","$rootScope","$compile",function(e,n,a,i,l,o,r,s){function p(t){var i;if(!t.match(/\.html$/))throw new Error('Wrong template url: "'+t+'"');return(i=a.get(t))?e.when(i):n.get(t,{cache:!0}).then(function(e){return a.put(t,e.data),e.data})["catch"](function(){throw new Error("Template located at "+t+" cannot be resolved.")})}function c(t,e){return e=e||{},angular.isFunction(t)||angular.isArray(t)?i.invoke(t,e):t}function u(t){return t[0].toUpperCase()+t.substr(1)}function g(t,e){e=e||{},b[t]=l(e)}function m(n,a){if(!a.service)throw new Error("'service' property required.");if(angular.isObject(a.service)?a.service=l(a.service):a.service=b[a.service],!a.columns)throw new Error("'columns' property must be specified.");a=angular.merge({},{service:b[a.service],columns:[],operations:[],sort:t.defaultSort,pagination:t.paginationConfig,filter:t.defaultFilter,templates:t.defaultTemplates},a);for(var i=a.pagination.pageSizeVariants.length-1;i>=0;i--){var o=a.pagination.pageSizeVariants[i];if(o.name=c(o.name),o.value==a.pagination.pageSize)break}0>i&&(a.pagination.pageSize=a.pagination.pageSizeVariants[0].value);var r=[],s=[],g={data:t.dataColumnConfig,checkbox:t.checkboxColumnConfig,operations:t.operationsColumnConfig};angular.forEach(a.columns,function(t,n){if(t.type||(t.type="data"),a.columns[n]=t=angular.merge({},g[t.type],t),"operations"!=t.type&&!t.attribute)throw new Error("'attribute' column option is required.");if("data"!=t.type||t.label||(t.label=u(t.attribute)),t.label&&(t.label=c(t.label)),t.filter&&h[t.filter]&&(s.push(h[t.filter]),h[t.filter].then(function(e){t.filter=e})),t.template)t.template=c(t.template),r.push(e.when(t));else{if(!t.templateUrl)throw new Error("Template for column '"+t.label+"' not specified.");r.push(p(c(t.templateUrl)).then(function(e){return t.template=e,t}))}});var m={};angular.forEach(a.templates,function(t,e){m[e]=p(c(t))}),angular.forEach(a.operations,function(e,n){angular.isString(e)?e=v[e]:(e=angular.merge({},t.operationConfig,e),e.label=c(e.label)),a.operations[n]=e}),w[n]=e.all({columns:e.all(r),templates:e.all(m),filters:e.all(s),config:a})}function d(e,n){n=angular.merge({},t.promptConfig,n),n.label=c(n.label),n.prompt.title=c(n.prompt.title),n.prompt.message=c(n.prompt.message);var a=n.make;n.make=function(e){if(n.prompt.enabled){var i=r.$new();return i.icon=n.icon,i.title=n.prompt.title,i.message=n.prompt.message,o.open({scope:i,templateUrl:t.defaultTemplates.modal}).result.then(function(){return a(e)})}return a(e)},v[e]=n}function f(t,n){n=angular.merge({},{controller:function(){},template:"",templateUrl:"templates/grid-view/text.tpl.html"},n);var a;n.template?(n.template=c(n.template),a=e.when(n)):n.templateUrl&&(a=p(c(n.templateUrl)).then(function(t){return n.template=t,n})),h[t]=a}var b={},h={},v={},w={},y=function(t){if(!w[t])throw new Error('Undefined grid widget: "'+t+'"');return w[t]};return angular.extend(y,{filter:function(t,e){return f(t,e),this},service:function(t,e){return g(t,e),this},prompt:function(t,e){return d(t,e),this},grid:function(t,e){return m(t,e),this}})}]}),angular.module("angular-grid-view").run(["gridView",function(t){t.filter("text",{templateUrl:"templates/grid-view/filter/text.tpl.html"}).filter("boolean",{templateUrl:"templates/grid-view/filter/select.tpl.html",controller:["$scope",function(t){t.options=[{value:void 0,label:"All"},{value:1,label:"Yes"},{value:0,label:"No"}]}]}).filter("daterange",{templateUrl:"templates/grid-view/filter/date-range.tpl.html",controller:["$scope",function(t){t.range={},t.$watchGroup(["range.startDate","range.endDate"],function(e,n){n[0]&&n[1]&&(t.filter[t.column.attribute]={from:parseInt(e[0].format("x")/1e3),to:parseInt(e[1].format("x")/1e3)})},!0)}]})}]),angular.module("angular-grid-view").provider("gridViewService",function(){this.defaults={url:"",filterParam:"filter",pageParam:"page",pageSizeParam:"page-size",sortParam:"sort",format:function(t){return{items:t.data,total:t.headers("X-Pagination-Total-Count")}}};var t=this;this.$get=["$http","$injector",function(e,n){function a(a){return a=angular.merge({},t.defaults,a),function(){var t,i,l=null,o=null;return{url:angular.isFunction(a.url)||angular.isArray(a.url)?n.invoke(a.url):a.url,filter:function(t){return l=t,this},sort:function(t){return o=t,this},page:function(e){return t=e,this},pageSize:function(t){return i=t,this},fetch:function(){var n={};n[a.filterParam]=l,n[a.pageParam]=t,n[a.pageSizeParam]=i,n[a.sortParam]=o;for(var r in n)(!n[r]||angular.equals(n[r],{}))&&delete n[r];return n=this.url.indexOf("?")>=0?this.url+"&"+jQuery.param(n):this.url+"?"+jQuery.param(n),e.get(n).then(function(t){return a.format(t)})["catch"](function(t){throw new Error(t.statusText)})}}}()}return function(t){return a(t)}}]}),angular.module("angular-grid-view").directive("bindHtmlCompile",["$compile",function(t){return{restrict:"A",link:function(e,n,a){e.$watch(function(){return e.$eval(a.bindHtmlCompile)},function(i){n.html(i&&i.toString());var l=e;a.bindHtmlScope&&(l=e.$eval(a.bindHtmlScope)),t(n.contents())(l)})}}}]),angular.module("angular-grid-view").directive("gridView",["gridView","$compile","$injector","$q","$timeout",function(t,e,n,a,i){return{scope:{name:"@"},link:function(l,o,r){function s(){return l.pending=!0,l.selected.items={},l.operation=null,l.service.filter(l.filter).sort(l.sort).page(l.pagination.page).pageSize(l.pagination.pageSize.value).fetch().then(function(t){return l.rows=t.items,l.total=t.total,t})["finally"](function(){l.pending=!1})}var p=t(l.name);p.then(function(t){var a=t.config,r=t.templates;t.filters;angular.extend(l,{min:Math.min,max:Math.max},a);for(var p=l.pagination.pageSizeVariants.length-1;p>=0;p--){var c=l.pagination.pageSizeVariants[p];if(c.value==l.pagination.pageSize){l.pagination.pageSize=c;break}}0>p&&(l.pagination.pageSize=l.pagination.pageSizeVariants[0]),l.keyAttribute=null;for(var p=l.columns.length-1;p>=0;p--)if("checkbox"==l.columns[p].type){l.keyAttribute=l.columns[p].attribute;break}s(),o.append(e(r.grid)(l)),i(function(){var a=angular.element("<tr></tr>");o.find("table thead").append(a),angular.forEach(t.columns,function(t){var i=t.filter,o=angular.element("<td></td>");if(i){var r=l.$new();r.column=t,n.invoke(i.controller,i,{$scope:r}),o.append(e(i.template)(r))}a.append(o)})})}),l.rows=[],l.pending=!0,l.total=0,l.selected={all:!1,items:{}},l.$watchCollection("selected.items",function(){var t=0;for(var e in l.selected.items)l.selected.items[e]&&t++;l.selected.all=!(!t||t!=l.rows.length)}),l.toggleAll=function(t){var e=0;for(var n in l.selected.items)l.selected.items[n]&&e++;for(var n in l.rows){var a=l.rows[n],i=a[t.attribute];l.selected.items[i]=e<l.rows.length}},l.sortColumn=function(t){if(!l.pending){var e="asc";l.sort[t.attribute]&&(e=l.sort[t.attribute].match(/asc/i)?"desc":"asc"),l.sort={},l.sort[t.attribute]=e}},l.$watchGroup(["sort","pagination.page","pagination.pageSize"],function(t,e){t!==e&&s()}),l.$watchCollection("filter",function(t,e){e!==t&&s()}),l.makeMultipleOperation=function(t){if(l.keyAttribute){var e=l.rows.filter(function(t){return t[l.keyAttribute]in l.selected.items});e.length&&(l.pending=!0,a.when(t.make(e)).then(function(e){return t.reloadOnDone?s():e})["finally"](function(){l.pending=!1,l.selected.items={}}))}},l.makeSingleOperation=function(t,e){l.pending=!0,a.when(t.make(e)).then(function(e){return t.reloadOnDone?s():e})["finally"](function(){l.pending=!1})}}}}]),angular.module("angular-grid-view").directive("gridViewDateRange",function(){return{restrict:"A",scope:{gridViewDateRange:"=?"},link:function(t,e,n){function a(n,a){e.html('               <span class="gv-nowrap">                  <i class="fa fa-calendar glyphicon glyphicon-calendar"></i>                  '+n.format(t.gridViewDateRange.locale.format)+" &mdash; "+a.format(t.gridViewDateRange.locale.format)+'                   <span class="caret"></span>               </span>')}t.gridViewDateRange=angular.extend({locale:{format:"DD.MM.YYYY"},linkedCalendars:!1,startDate:moment("2000-01-01"),endDate:moment(),showDropdowns:!0,autoUpdateInput:!0,opens:"center",ranges:{Today:[moment(),moment()],Yesterday:[moment().subtract(1,"days"),moment().subtract(1,"days")],"Last 7 Days":[moment().subtract(6,"days"),moment()],"Last 30 Days":[moment().subtract(29,"days"),moment()],"Last 6 Months":[moment().subtract(6,"months"),moment()],All:[moment("2000-01-01"),moment()]}},t.gridViewDateRange),t.$watchGroup(["gridViewDateRange.startDate","gridViewDateRange.endDate"],function(t){a(moment(t[0]),moment(t[1]))}),e.daterangepicker(t.gridViewDateRange,function(e,n,a){t.$apply(function(){t.gridViewDateRange.startDate=e,t.gridViewDateRange.endDate=n})})}}}),angular.module("grid-view-templates",[]).run(["$templateCache",function(t){t.put("templates/grid-view/_operations.tpl.html",'<div class="btn-group btn-group-sm gv-operations" role="group" ng-if="(operations|filter:{multiple:true}).length">\n  <div uib-dropdown class="btn-group btn-group-sm">\n    <button uib-dropdown-toggle class="btn btn-default btn-sm btn-block" ng-disabled="pending">\n      <span ng-show="!operation">Operation</span>\n      <span ng-show="operation" ng-bind-html="operation.label"></span>\n      <span class="caret"></span>\n    </button>\n    <ul class="uib-dropdown-menu">\n      <li ng-repeat="o in operations | filter:{multiple:true}">\n        <a href ng-click="$parent[\'operation\'] = o;">\n          <i class="{{o.icon}}"></i> <span ng-bind-html="o.label"></span>\n        </a>\n      </li>\n     <li role="separator" class="divider"></li>\n      <li>\n        <a href ng-click="operation = null;">\n          Cancel\n        </a>\n      </li>\n    </ul>\n  </div>\n  <button ng-disabled="pending" type="button" class="btn btn-default" ng-if="operation.multiple" ng-click="makeMultipleOperation(operation)">Apply</button>\n</div>\n'),t.put("templates/grid-view/_page-size.tpl.html",'<div uib-dropdown class="gv-page-size-dropdown btn-group" >\n  <button uib-dropdown-toggle class="btn btn-default btn-sm btn-block" ng-disabled="pending">\n    <span ng-bind-html="pagination.pageSize.name"></span>\n    <span class="caret"></span>\n  </button>\n  <ul class="uib-dropdown-menu">\n    <li ng-repeat="variant in pagination.pageSizeVariants">\n      <a href ng-click="$parent.$parent.pagination.pageSize = variant">\n        <span ng-bind-html="variant.name"></span>\n      </a>\n    </li>\n  </ul>\n</div>\n'),t.put("templates/grid-view/_pagination.tpl.html",'  <uib-pagination\n    ng-if="rows.length"\n    total-items="total"\n    items-per-page="pagination.pageSize.value"\n    ng-model="$parent.pagination.page"\n    max-size="4"\n    class="pagination-sm gv-pagination"\n    direction-links="false"\n    boundary-links="true"\n    first-text="&laquo;"\n    last-text="&raquo;"\n    ng-disabled="pending">\n  </uib-pagination>\n'),t.put("templates/grid-view/_summary.tpl.html",'<div class="gv-summary" ng-show="total" ng-if="rows.length">\n  Showing <b><span ng-bind="pagination.pageSize.value * (pagination.page - 1) + 1"></span>-<span ng-bind="min(pagination.pageSize.value * pagination.page, total)"></span></b> of\n  <b ng-bind="total"></b>.\n</div>\n'),t.put("templates/grid-view/_table.tpl.html",'<table class="gv-table table table-condensed table-striped table-bordered table-hover">\n  <thead>\n    <tr>\n      <td ng-repeat="column in columns">\n        <span class="gv-cell-check-all" ng-if="column.type == \'checkbox\';">\n          <input type="checkbox" ng-model="selected.all" ng-change="toggleAll(column)" ng-disabled="pending" />\n        </span>\n        <span class="gv-cell-caption" ng-if="column.type == \'data\' && !column.sortable">\n          <span ng-bind-html="column.label"></span>\n          <i class="pull-right glyphicon" ng-class="{\'glyphicon-sort-by-attributes\': sort[column.attribute] == \'asc\', \'glyphicon-sort-by-attributes-alt\': sort[column.attribute] == \'dec\'}"></i>\n        </span>\n        <a href ng-disabled="pending" class="gv-cell-caption" ng-if="column.type == \'data\' && column.sortable" ng-click="sortColumn(column)">\n          <span ng-bind-html="column.label"></span>\n          <i class="glyphicon" ng-class="{\'glyphicon-sort-by-attributes\': sort[column.attribute] == \'asc\', \'glyphicon-sort-by-attributes-alt\': sort[column.attribute] == \'desc\'}"></i>\n        </a>\n        <span class="gv-cell-caption" ng-if="column.type == \'operations\'" ng-bind-html="column.label"></span>\n      </td>\n    </tr>\n  </thead>\n  <tbody>\n    <tr ng-repeat="row in rows">\n      <td ng-repeat="column in columns" bind-html-compile="column.template"></td>\n    </tr>\n    <tr ng-if="!rows.length">\n      <td colspan="{{columns.length}}" class="text-center text-muted">\n         <i class="glyphicon glyphicon-info-sign"></i> No records found.\n      </td>\n   </tr>\n  </tbody>\n</table>\n'),t.put("templates/grid-view/grid-view.tpl.html",'<div class="gv-container">\n  <div class="row">\n    <div class="col-xs-6" ng-include="templates.operationsDropdown"></div>\n    <div class="col-xs-offset-3 col-xs-3 text-right" ng-include="templates.pageSizeDropdown"></div>\n  </div>\n  <div class="row">\n    <div class="col-xs-6 text-left" ng-include="templates.summary"></div>\n    <div class="col-xs-6 text-right" ng-include="templates.pagination"></div>\n  </div>\n  <div class="row">\n    <div class="col-xs-12" ng-include="templates.table"></div>\n  </div>\n  <div class="row">\n    <div class="col-xs-6 text-left" ng-include="templates.summary"></div>\n    <div class="col-xs-6 text-right" ng-include="templates.pagination"></div>\n  </div>\n</div>\n'),t.put("templates/grid-view/modal.tpl.html",'<div class="modal-header">\n   <h3 class="modal-title">\n     <i class="{{icon}}"></i>\n     {{title}}\n   </h3>\n</div>\n<div class="modal-body" ng-bind-html="message"></div>\n<div class="modal-footer">\n   <button class="btn btn-primary" type="button" ng-click="$close(true)">OK</button>\n   <button class="btn btn-warning" type="button" ng-click="$dismiss(false)">No</button>\n</div>\n'),t.put("templates/grid-view/cell/boolean.tpl.html",'<div class="text-center">\n   <i ng-if="+row[column.attribute]" class="text-success glyphicon glyphicon-ok-circle" title="Yes"></i>\n   <i ng-if="!+row[column.attribute]" class="text-muted glyphicon glyphicon-ban-circle" title="No"></i>\n</div>\n'),t.put("templates/grid-view/cell/checkbox.tpl.html",'<span><input ng-disabled="pending" type="checkbox" ng-model="selected.items[row[column.attribute]]" /></span>\n'),t.put("templates/grid-view/cell/data.tpl.html","<span>{{row[column.attribute]}}</span>\n"),t.put("templates/grid-view/cell/date.tpl.html",'<time class="gv-nowrap">\n   <i class="glyphicon glyphicon-calendar"></i>\n   {{row[column.attribute] * 1000 | date:"dd.MM.yyyy"}}\n</time>\n'),t.put("templates/grid-view/cell/datetime.tpl.html",'<time class="gv-nowrap text-right">\n   <i class="glyphicon glyphicon-calendar"></i> {{row[column.attribute] * 1000 | date:"dd.MM.yyyy"}}\n   <br/>\n   <small class="gv-nowrap">{{row[column.attribute] * 1000 | date:"HH:mm:ss"}}</small>\n</time>\n'),t.put("templates/grid-view/cell/email.tpl.html",'<a ng-href="{{\'mailto:\' + row[column.attribute]}}" class="gv-nowrap">\n   {{row[column.attribute]}}\n</a>\n'),t.put("templates/grid-view/cell/img.tpl.html",'<p class="text-center">\n  <img ng-src="{{row[column.attribute]}}" class="img-responsive" />\n</p>\n'),t.put("templates/grid-view/cell/operations.tpl.html",'<div class="btn-group btn-group-sm gv-operations-group">\n  <button class="btn btn-default"\n          type="button"\n          ng-repeat="operation in operations"\n          ng-if="operation.single && operation.condition(row)"\n          title="{{operation.label}}"\n          ng-disabled="pending"\n          ng-click="makeSingleOperation(operation, row)">\n    <i class="{{operation.icon}}"></i>\n  </button>\n</div>\n'),t.put("templates/grid-view/filter/autocomplete.tpl.html",'<ui-select ng-model="filter[column.attribute]" theme="select2" class="form-control input-sm" title="{{column.label}}" append-to-body="false" ng-disabled="pending" theme="bootstrap">\n   <ui-select-match placeholder="{{column.label}}">{{$select.selected.label}}</ui-select-match>\n   <ui-select-choices repeat="option.value as option in options | filter: $select.search">\n      <div ng-bind-html="option.label | highlight: $select.search"></div>\n   </ui-select-choices>\n</ui-select>\n'),t.put("templates/grid-view/filter/date-range.tpl.html",'<button type="button" class="btn btn-default btn-sm" grid-view-date-range="range" ng-disabled="pending"></button>\n'),t.put("templates/grid-view/filter/dropdown.tpl.html",'<ui-select ng-model="filter[column.attribute]" theme="select2" class="gv-dropdown form-control input-sm" title="{{column.label}}" append-to-body="false" ng-disabled="pending" theme="bootstrap" search-enabled="false">\n   <ui-select-match placeholder="{{column.label}}">{{$select.selected.label}}</ui-select-match>\n   <ui-select-choices repeat="option.value as option in options | filter: $select.search">\n      <div ng-bind-html="option.label | highlight: $select.search"></div>\n   </ui-select-choices>\n</ui-select>\n'),t.put("templates/grid-view/filter/select.tpl.html",'<div class="gv-select-filter">\n  <select class="form-control input-sm"\n         ng-disabled="pending"\n          ng-model="filter[column.attribute]"\n          ng-options="option.value as option.label for option in options"></select>\n</div>\n'),t.put("templates/grid-view/filter/text.tpl.html",'<div class="gv-text-filter">\n  <input type="text"\n      ng-disabled="pending"\n        class="form-control input-sm"\n        ng-model="filter[column.attribute]"\n        ng-model-options="{debounce: 1000}"\n        placeholder="{{column.label}}"/>\n</div>\n')}]);